version: '3'

tasks:
  complexity:
    desc: Analyze code complexity using Lizard
    summary: |
      Performs code complexity analysis on the codebase using Lizard.
      Generates both text and CSV reports with configurable thresholds.
      
      Usage:
        task complexity           # Run analysis
        task complexity -- -v     # Verbose output
    cmds:
      - task: complexity:check-tool
      - task: complexity:analyze
      - task: complexity:report
    silent: false

  complexity:check-tool:
    desc: Check if Lizard is installed, install if necessary
    internal: true
    cmds:
      - |
        if ! command -v lizard &> /dev/null; then
          echo "ğŸ“¦ Installing Lizard..."
          
          INSTALL_SUCCESS=0
          
          if command -v pip3 &> /dev/null; then
            echo "Trying pip3..."
            if pip3 install --user lizard; then
              INSTALL_SUCCESS=1
            fi
          elif command -v pip &> /dev/null; then
            echo "Trying pip..."
            if pip install --user lizard; then
              INSTALL_SUCCESS=1
            fi
          elif command -v sudo &> /dev/null && command -v apt-get &> /dev/null; then
            echo "Trying apt-get..."
            if sudo apt-get update && sudo apt-get install -y python3-pip && pip3 install --user lizard; then
              INSTALL_SUCCESS=1
            fi
          elif command -v brew &> /dev/null; then
            echo "Trying brew..."
            if brew install lizard; then
              INSTALL_SUCCESS=1
            fi
          fi
          
          if [ $INSTALL_SUCCESS -eq 0 ]; then
            echo "âŒ Failed to install Lizard with any available package manager"
            echo "Please install Lizard manually:"
            echo "  - pip install lizard"
            echo "  - brew install lizard"
            echo "  - https://github.com/terryyin/lizard"
            exit 1
          fi
        fi
        
        # Verify installation succeeded
        if ! command -v lizard &> /dev/null; then
          echo "âŒ Lizard installed but not found in PATH"
          exit 1
        fi
        
        LIZARD_VERSION=$(lizard --version 2>&1)
        echo "âœ… Lizard $LIZARD_VERSION"
    silent: false

  complexity:analyze:
    desc: Run Lizard analysis and generate reports
    internal: true
    dir: .
    cmds:
      - |
        echo ""
        echo "ğŸ” Analyzing code complexity..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Create reports directory
        mkdir -p .complexity-reports
        
        # Run lizard and generate text report (intermediate)
        lizard . \
          -x "tests/*" \
          -x ".github/*" \
          -x "node_modules/*" \
          -x ".git/*" \
          -o ".complexity-reports/complexity-report-raw.txt" \
          || true
        
        # Generate CSV report for structured data
        lizard . \
          -x "tests/*" \
          -x ".github/*" \
          -x "node_modules/*" \
          -x ".git/*" \
          --csv > ".complexity-reports/complexity-report.csv" \
          || true
        
        # Convert to markdown using Python
        python3 .scripts/generate-complexity-md.py
        
        echo "âœ… Analysis complete"
    silent: false

  complexity:report:
    desc: Display formatted complexity report
    internal: true
    cmds:
      - |
        echo ""
        echo "ğŸ“Š COMPLEXITY REPORT"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        if [ ! -f .complexity-reports/complexity-report.md ]; then
          echo "âŒ Complexity report not generated!"
          echo "This indicates an error in the analysis step. Check the logs above."
          exit 1
        fi
        
        cat .complexity-reports/complexity-report.md
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Reports saved to: .complexity-reports/"
        echo "   â€¢ complexity-report.md (human-readable)"
        echo "   â€¢ complexity-report.csv (machine-readable)"
        echo ""
        
        # Check for high complexity issues (CCN in column 2, indexed as $2)
        if [ -f .complexity-reports/complexity-report.csv ]; then
          HIGH_COMPLEXITY=$(awk -F',' '$2 > 10' .complexity-reports/complexity-report.csv | wc -l)
          if [ "$HIGH_COMPLEXITY" -gt 0 ]; then
            echo "âš ï¸  Found $HIGH_COMPLEXITY item(s) with cyclomatic complexity > 10"
            echo ""
          else
            echo "âœ… No high-complexity items found (all CCN â‰¤ 10)"
            echo ""
          fi
        fi
    silent: false

  gitleaks:
    desc: Scan repository for secrets using Gitleaks
    summary: |
      Scans the git repository for hardcoded secrets, API keys, and credentials.
      Generates a JSON report and a human-readable Markdown report.

      Usage:
        task gitleaks           # Run scan
    cmds:
      - task: gitleaks:check-tool
      - task: gitleaks:scan
      - task: gitleaks:report
    silent: false

  gitleaks:check-tool:
    desc: Check if Gitleaks is installed, install if necessary
    internal: true
    cmds:
      - |
        if ! command -v gitleaks &> /dev/null; then
          echo "ğŸ“¦ Installing Gitleaks..."

          INSTALL_SUCCESS=0

          if command -v brew &> /dev/null; then
            echo "Trying brew..."
            if brew install gitleaks; then
              INSTALL_SUCCESS=1
            fi
          fi

          if [ $INSTALL_SUCCESS -eq 0 ]; then
            echo "Trying GitHub releases..."
            OS=$(uname -s | tr '[:upper:]' '[:lower:]')
            ARCH=$(uname -m)
            if [ "$ARCH" = "x86_64" ]; then ARCH="x64"; fi
            if [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi
            LATEST=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name"' | cut -d '"' -f 4)
            VERSION=${LATEST#v}
            URL="https://github.com/gitleaks/gitleaks/releases/download/${LATEST}/gitleaks_${VERSION}_${OS}_${ARCH}.tar.gz"
            echo "Downloading $URL..."
            if curl -sL "$URL" -o /tmp/gitleaks.tar.gz && \
               tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks && \
               sudo mv /tmp/gitleaks /usr/local/bin/gitleaks; then
              INSTALL_SUCCESS=1
            fi
          fi

          if [ $INSTALL_SUCCESS -eq 0 ]; then
            echo "âŒ Failed to install Gitleaks"
            echo "Please install Gitleaks manually:"
            echo "  - brew install gitleaks"
            echo "  - https://github.com/gitleaks/gitleaks/releases"
            exit 1
          fi
        fi

        GITLEAKS_VERSION=$(gitleaks version 2>&1)
        echo "âœ… Gitleaks $GITLEAKS_VERSION"
    silent: false

  gitleaks:scan:
    desc: Run Gitleaks scan and generate reports
    internal: true
    dir: .
    cmds:
      - |
        echo ""
        echo "ğŸ” Scanning for secrets..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        mkdir -p .gitleaks-reports

        # Run gitleaks and output JSON report (exit code 1 if leaks found, 0 if clean)
        set +e
        gitleaks detect \
          --source . \
          --report-format json \
          --report-path .gitleaks-reports/gitleaks-report.json \
          --exit-code 1
        GITLEAKS_EXIT=$?
        set -e

        # Ensure the JSON report exists even when no leaks are found
        if [ ! -f .gitleaks-reports/gitleaks-report.json ]; then
          echo "[]" > .gitleaks-reports/gitleaks-report.json
        fi

        # Convert to markdown using Python
        python3 .scripts/generate-gitleaks-report.py

        echo "âœ… Scan complete (exit code: $GITLEAKS_EXIT)"
        exit $GITLEAKS_EXIT
    silent: false

  gitleaks:report:
    desc: Display formatted secrets scan report
    internal: true
    cmds:
      - |
        echo ""
        echo "ğŸ” SECRETS SCAN REPORT"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        if [ ! -f .gitleaks-reports/gitleaks-report.md ]; then
          echo "âŒ Secrets report not generated!"
          echo "This indicates an error in the scan step. Check the logs above."
          exit 1
        fi

        cat .gitleaks-reports/gitleaks-report.md

        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Reports saved to: .gitleaks-reports/"
        echo "   â€¢ gitleaks-report.md (human-readable)"
        echo "   â€¢ gitleaks-report.json (machine-readable)"
        echo ""
    silent: false

  test:
    desc: Run Playwright tests
    cmds:
      - npx playwright test {{.CLI_ARGS}}

  test:headed:
    desc: Run Playwright tests with headed browser
    cmds:
      - npx playwright test --headed {{.CLI_ARGS}}

  test:gitleaks:
    desc: Run gitleaks report generation tests
    cmds:
      - python3 tests/generate_gitleaks_report.test.py

  test:complexity:
    desc: Run complexity report generation tests
    cmds:
      - python3 tests/generate_complexity_report.test.py

  start:
    desc: Start local development server
    cmds:
      - npx http-server . -p 8080 -o
