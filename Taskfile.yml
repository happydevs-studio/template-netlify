version: '3'

tasks:
  complexity:
    desc: Analyze code complexity using Lizard
    summary: |
      Performs code complexity analysis on the codebase using Lizard.
      Generates both text and CSV reports with configurable thresholds.
      
      Usage:
        task complexity           # Run analysis
        task complexity -- -v     # Verbose output
    cmds:
      - task: complexity:check-tool
      - task: complexity:analyze
      - task: complexity:report
    silent: false

  complexity:check-tool:
    desc: Check if Lizard is installed, install if necessary
    internal: true
    cmds:
      - |
        if ! command -v lizard &> /dev/null; then
          echo "ğŸ“¦ Installing Lizard..."
          
          INSTALL_SUCCESS=0
          
          if command -v pip3 &> /dev/null; then
            echo "Trying pip3..."
            if pip3 install --user lizard; then
              INSTALL_SUCCESS=1
            fi
          elif command -v pip &> /dev/null; then
            echo "Trying pip..."
            if pip install --user lizard; then
              INSTALL_SUCCESS=1
            fi
          elif command -v sudo &> /dev/null && command -v apt-get &> /dev/null; then
            echo "Trying apt-get..."
            if sudo apt-get update && sudo apt-get install -y python3-pip && pip3 install --user lizard; then
              INSTALL_SUCCESS=1
            fi
          elif command -v brew &> /dev/null; then
            echo "Trying brew..."
            if brew install lizard; then
              INSTALL_SUCCESS=1
            fi
          fi
          
          if [ $INSTALL_SUCCESS -eq 0 ]; then
            echo "âŒ Failed to install Lizard with any available package manager"
            echo "Please install Lizard manually:"
            echo "  - pip install lizard"
            echo "  - brew install lizard"
            echo "  - https://github.com/terryyin/lizard"
            exit 1
          fi
        fi
        
        # Verify installation succeeded
        if ! command -v lizard &> /dev/null; then
          echo "âŒ Lizard installed but not found in PATH"
          exit 1
        fi
        
        LIZARD_VERSION=$(lizard --version 2>&1)
        echo "âœ… Lizard $LIZARD_VERSION"
    silent: false

  complexity:analyze:
    desc: Run Lizard analysis and generate reports
    internal: true
    dir: .
    cmds:
      - |
        echo ""
        echo "ğŸ” Analyzing code complexity..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Create reports directory
        mkdir -p .complexity-reports
        
        # Run lizard and generate text report (intermediate)
        lizard . \
          -x "tests/*" \
          -x ".github/*" \
          -x "node_modules/*" \
          -x ".git/*" \
          -o ".complexity-reports/complexity-report-raw.txt" \
          || true
        
        # Generate CSV report for structured data
        lizard . \
          -x "tests/*" \
          -x ".github/*" \
          -x "node_modules/*" \
          -x ".git/*" \
          --csv > ".complexity-reports/complexity-report.csv" \
          || true
        
        # Convert to markdown using Python
        python3 .scripts/generate-complexity-md.py
        
        echo "âœ… Analysis complete"
    silent: false

  complexity:report:
    desc: Display formatted complexity report
    internal: true
    cmds:
      - |
        echo ""
        echo "ğŸ“Š COMPLEXITY REPORT"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        if [ ! -f .complexity-reports/complexity-report.md ]; then
          echo "âŒ Complexity report not generated!"
          echo "This indicates an error in the analysis step. Check the logs above."
          exit 1
        fi
        
        cat .complexity-reports/complexity-report.md
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Reports saved to: .complexity-reports/"
        echo "   â€¢ complexity-report.md (human-readable)"
        echo "   â€¢ complexity-report.csv (machine-readable)"
        echo ""
        
        # Check for high complexity issues (CCN in column 2, indexed as $2)
        if [ -f .complexity-reports/complexity-report.csv ]; then
          HIGH_COMPLEXITY=$(awk -F',' '$2 > 10' .complexity-reports/complexity-report.csv | wc -l)
          if [ "$HIGH_COMPLEXITY" -gt 0 ]; then
            echo "âš ï¸  Found $HIGH_COMPLEXITY item(s) with cyclomatic complexity > 10"
            echo ""
          else
            echo "âœ… No high-complexity items found (all CCN â‰¤ 10)"
            echo ""
          fi
        fi
    silent: false

  trivy:
    desc: Run security scan using Trivy
    summary: |
      Performs security vulnerability scanning on the codebase using Trivy.
      Scans for vulnerabilities in dependencies, secrets, and misconfigurations.
      
      Usage:
        task trivy           # Run scan
        task trivy -- -v     # Verbose output
    cmds:
      - task: trivy:check-tool
      - task: trivy:scan
      - task: trivy:report
    silent: false

  trivy:check-tool:
    desc: Check if Trivy is installed, install if necessary
    internal: true
    cmds:
      - |
        if ! command -v trivy &> /dev/null; then
          echo "ğŸ“¦ Installing Trivy..."
          
          INSTALL_SUCCESS=0
          
          if command -v curl &> /dev/null; then
            echo "Installing via install script..."
            if curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin; then
              INSTALL_SUCCESS=1
            fi
          elif command -v brew &> /dev/null; then
            echo "Trying brew..."
            if brew install trivy; then
              INSTALL_SUCCESS=1
            fi
          fi
          
          if [ $INSTALL_SUCCESS -eq 0 ]; then
            echo "âŒ Failed to install Trivy with any available package manager"
            echo "Please install Trivy manually:"
            echo "  - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh"
            echo "  - brew install trivy"
            echo "  - https://aquasecurity.github.io/trivy/latest/getting-started/installation/"
            exit 1
          fi
        fi
        
        # Verify installation succeeded
        if ! command -v trivy &> /dev/null; then
          echo "âŒ Trivy installed but not found in PATH"
          exit 1
        fi
        
        TRIVY_VERSION=$(trivy --version 2>&1 | head -1)
        echo "âœ… $TRIVY_VERSION"
    silent: false

  trivy:scan:
    desc: Run Trivy scan and generate reports
    internal: true
    dir: .
    cmds:
      - |
        echo ""
        echo "ğŸ” Scanning for security vulnerabilities..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Create reports directory
        mkdir -p .trivy-reports
        
        # Run trivy filesystem scan (text output for human-readable)
        trivy fs . \
          --exit-code 0 \
          --severity HIGH,CRITICAL,MEDIUM,LOW \
          --scanners vuln,secret,misconfig \
          --skip-dirs node_modules \
          --skip-dirs .git \
          --format table \
          --output ".trivy-reports/trivy-report.txt" \
          || true
        
        # Run trivy filesystem scan (JSON output for machine-readable)
        trivy fs . \
          --exit-code 0 \
          --severity HIGH,CRITICAL,MEDIUM,LOW \
          --scanners vuln,secret,misconfig \
          --skip-dirs node_modules \
          --skip-dirs .git \
          --format json \
          --output ".trivy-reports/trivy-report.json" \
          || true
        
        # Convert to markdown using Python
        python3 .scripts/generate-trivy-md.py
        
        echo "âœ… Scan complete"
    silent: false

  trivy:report:
    desc: Display formatted Trivy scan report
    internal: true
    cmds:
      - |
        echo ""
        echo "ğŸ”’ SECURITY SCAN REPORT"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        if [ ! -f .trivy-reports/trivy-report.md ]; then
          echo "âŒ Trivy report not generated!"
          echo "This indicates an error in the scan step. Check the logs above."
          exit 1
        fi
        
        cat .trivy-reports/trivy-report.md
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Reports saved to: .trivy-reports/"
        echo "   â€¢ trivy-report.md (human-readable)"
        echo "   â€¢ trivy-report.json (machine-readable)"
        echo ""
        
        # Check for high/critical vulnerabilities
        if [ -f .trivy-reports/trivy-report.json ]; then
          HIGH_CRITICAL=$(python3 -c "
import json, sys
try:
    with open('.trivy-reports/trivy-report.json') as f:
        data = json.load(f)
    count = 0
    for result in data.get('Results', []):
        for vuln in result.get('Vulnerabilities') or []:
            if vuln.get('Severity') in ('HIGH', 'CRITICAL'):
                count += 1
    print(count)
except Exception:
    print(0)
")
          if [ "$HIGH_CRITICAL" -gt 0 ]; then
            echo "âš ï¸  Found $HIGH_CRITICAL HIGH/CRITICAL vulnerability/ies"
            echo ""
          else
            echo "âœ… No HIGH/CRITICAL vulnerabilities found"
            echo ""
          fi
        fi
    silent: false

  test:
    desc: Run Playwright tests
    cmds:
      - npx playwright test {{.CLI_ARGS}}

  test:headed:
    desc: Run Playwright tests with headed browser
    cmds:
      - npx playwright test --headed {{.CLI_ARGS}}

  test:complexity:
    desc: Run complexity report generation tests
    cmds:
      - python3 tests/generate_complexity_report.test.py

  test:trivy:
    desc: Run Trivy report generation tests
    cmds:
      - python3 tests/generate_trivy_report.test.py

  start:
    desc: Start local development server
    cmds:
      - npx http-server . -p 8080 -o
