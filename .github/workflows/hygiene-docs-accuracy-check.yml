name: Hygiene - Documentation Accuracy Check

on:
  # â”€â”€ Weekly schedule (every Monday at 07:00 UTC) â”€â”€
  schedule:
    - cron: '0 7 * * 1'

  # â”€â”€ Also run on PRs/pushes that touch docs or project structure â”€â”€
  pull_request:
    paths:
      - 'docs/**'
      - '*.html'
      - '*.js'
      - '*.css'
      - 'Taskfile.yml'
      - 'netlify.toml'
      - 'server.js'
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '*.html'
      - '*.js'
      - '*.css'
      - 'Taskfile.yml'
      - 'netlify.toml'
      - 'server.js'
      - '.github/workflows/**'

  # â”€â”€ Manual trigger â”€â”€
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-docs-accuracy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Task
        run: |
          curl -sL https://taskfile.dev/install.sh | sh -s -- -b /usr/local/bin
          task --version

      - name: Run documentation accuracy check
        id: accuracy
        run: |
          python3 .scripts/check-docs-accuracy.py || true
          python3 .scripts/generate-docs-accuracy-md.py || true

          if [ -f .docs-reports/docs-accuracy-report.json ]; then
            ISSUE_COUNT=$(python3 -c "
          import json
          with open('.docs-reports/docs-accuracy-report.json') as f:
            data = json.load(f)
          print(data.get('issue_count', 0))
          " 2>/dev/null || echo "0")
            echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT

            if [ "$ISSUE_COUNT" -gt 0 ]; then
              echo "has_issues=true" >> $GITHUB_OUTPUT
            else
              echo "has_issues=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "issue_count=0" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy report for workflow
        run: cp .docs-reports/docs-accuracy-report.md docs-accuracy-report.md || true

      # â”€â”€ PR comment â”€â”€
      - name: Comment on PR with accuracy report
        if: github.event_name == 'pull_request' && steps.accuracy.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = '';
            try {
              reportContent = fs.readFileSync('docs-accuracy-report.md', 'utf8');
            } catch (e) {
              reportContent = 'âŒ Failed to read accuracy report';
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = 'ðŸ”Ž Documentation Accuracy';
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: reportContent
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: reportContent
              });
            }

      # â”€â”€ Issue creation on main push or schedule â”€â”€
      - name: Create or update issue when accuracy problems found
        if: >
          (github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
          && steps.accuracy.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = 'Unable to read accuracy report';
            try {
              reportContent = fs.readFileSync('docs-accuracy-report.md', 'utf8');
            } catch (e) {
              console.log('Report not found:', e.message);
            }

            const label = 'documentation-accuracy';
            const title = 'ðŸ”Ž Documentation Accuracy Issues';
            const body = `Documentation accuracy checks have detected stale or broken references.

            ## Report
            ${reportContent}

            ## To Fix
            \`\`\`bash
            task hygiene:docs-accuracy
            \`\`\`

            Review each issue, update the docs to match the current project, then re-run the check.

            ---
            *This issue was automatically created by the Documentation Accuracy Check workflow.*
            ${context.sha ? `Commit: ${context.sha}` : ''}`.replace(/^            /gm, '');

            // Check for existing open issue with same label
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: label
            });

            if (issues.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: body
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `ðŸ”” Documentation accuracy issues detected again (${context.sha || 'scheduled run'})`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: [label, 'documentation']
              });
            }

      # â”€â”€ Close issue when clean â”€â”€
      - name: Close issue when docs are clean
        if: >
          (github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
          && steps.accuracy.outputs.has_issues == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const label = 'documentation-accuracy';
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: label
            });

            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… Documentation accuracy checks now pass. Closing automatically.'
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Upload accuracy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-accuracy-report
          path: .docs-reports/docs-accuracy-report.md
          retention-days: 30
