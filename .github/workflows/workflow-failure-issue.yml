name: Raise Issue on Workflow Failure

on:
  check_suite:
    types:
      - completed

permissions:
  issues: write
  actions: read  # needed to list workflow runs for the check suite via the API

jobs:
  raise-issue:
    # Only act on GitHub Actions check suites that failed on main
    if: >
      github.event.check_suite.conclusion == 'failure' &&
      github.event.check_suite.head_branch == 'main' &&
      github.event.check_suite.app.slug == 'github-actions'
    runs-on: ubuntu-latest
    steps:
      - name: Create or update issue for each failed workflow run
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.check_suite.head_sha;
            const branch = context.payload.check_suite.head_branch;
            const checkSuiteId = context.payload.check_suite.id;
            const label = 'workflow-failure';

            // Fetch all workflow runs belonging to this check suite
            const { data: runsData } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_suite_id: checkSuiteId,
            });

            const failedRuns = runsData.workflow_runs.filter(run => run.conclusion === 'failure');

            for (const run of failedRuns) {
              const workflowName = run.name;
              const runId = run.id;
              const runUrl = run.html_url;
              const title = `âŒ Workflow Failure: ${workflowName}`;

              // Skip if any open issue already references this run URL.
              // Workflows that raise their own domain-specific issues (e.g. SAST,
              // DAST, secrets, complexity) include the run URL in their issue body,
              // so this prevents a duplicate generic issue being raised alongside them.
              const { data: runSearch } = await github.rest.search.issuesAndPullRequests({
                q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open ${runUrl} in:body`,
              });
              if (runSearch.total_count > 0) {
                continue;
              }

              const body = [
                `## Workflow Failure Detected`,
                ``,
                `**Workflow:** ${workflowName}`,
                `**Branch:** ${branch}`,
                `**Commit:** [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha})`,
                `**Run:** [#${runId}](${runUrl})`,
                ``,
                `The **${workflowName}** workflow failed on the \`main\` branch.`,
                ``,
                `[View the failed workflow run](${runUrl})`,
                ``,
                `---`,
                `*This issue was automatically created by the Raise Issue on Workflow Failure workflow.*`
              ].join('\n');

              // Check for an existing open workflow-failure issue for this workflow
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: [label]
              });

              const existingIssue = issues.find(issue => issue.title === title);

              if (existingIssue) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: [
                    `## New Failure`,
                    ``,
                    `**Time:** ${new Date().toISOString()}`,
                    `**Commit:** [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha})`,
                    `**Run:** [#${runId}](${runUrl})`
                  ].join('\n')
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: [label]
                });
              }
            }
