name: Raise Issue on Workflow Failure

on:
  workflow_run:
    workflows:
      - "Hygiene - Auto Label PRs"
      - "Code Complexity Check"
      - "Hygiene - Documentation Updater"
      - "Hygiene - Documentation Accuracy Check"
      - "Documentation Size Monitor"
      - "Hygiene - Documentation Structure Check"
      - "Cleanup Netlify Preview"
      - "Deploy to Netlify"
      - "Playwright Tests"
      - "Reliability Smoke Tests"
      - "DAST Analysis"
      - "SAST Analysis"
      - "Secrets Detection"
      - "Dependency Vulnerability Scan"
      - "Dependency review"
    types:
      - completed

permissions:
  issues: write

jobs:
  raise-issue:
    # Only act on workflow runs that failed on main
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Create or update issue for failed workflow run
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const runId = context.payload.workflow_run.id;
            const runUrl = context.payload.workflow_run.html_url;
            const sha = context.payload.workflow_run.head_sha;
            const branch = context.payload.workflow_run.head_branch;
            const label = 'workflow-failure';
            const title = `❌ Workflow Failure: ${workflowName}`;

            // Skip if any open issue already references this run URL.
            // Workflows that raise their own domain-specific issues (e.g. SAST,
            // DAST, secrets, complexity) include the run URL in their issue body,
            // so this prevents a duplicate generic issue being raised alongside them.
            // Use direct listing instead of search API to avoid indexing delays.
            // Note: per_page=100 is sufficient for this template repo; add pagination if issue volume grows.
            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            if (openIssues.some(issue => issue.body && issue.body.includes(runUrl))) {
              return;
            }

            const body = [
              `## Workflow Failure Detected`,
              ``,
              `**Workflow:** ${workflowName}`,
              `**Branch:** ${branch}`,
              `**Commit:** [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha})`,
              `**Run:** [#${runId}](${runUrl})`,
              ``,
              `The **${workflowName}** workflow failed on the \`main\` branch.`,
              ``,
              `[View the failed workflow run](${runUrl})`,
              ``,
              `---`,
              `*This issue was automatically created by the Raise Issue on Workflow Failure workflow.*`
            ].join('\n');

            // Check for an existing open workflow-failure issue for this workflow
            const existingIssue = openIssues.find(issue =>
              issue.title === title && issue.labels.some(l => l.name === label)
            );

            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: [
                  `## New Failure`,
                  ``,
                  `**Time:** ${new Date().toISOString()}`,
                  `**Commit:** [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha})`,
                  `**Run:** [#${runId}](${runUrl})`
                ].join('\n')
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: [label]
              });
            }

  close-issue:
    # Close any open workflow-failure issue when the workflow passes on main
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Close issue for recovered workflow
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const label = 'workflow-failure';
            const title = `❌ Workflow Failure: ${workflowName}`;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: [label]
            });

            const matchingIssues = issues.filter(issue => issue.title === title);
            for (const issue of matchingIssues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `✅ The **${workflowName}** workflow is now passing on the \`main\` branch. Closing this issue automatically.`
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
